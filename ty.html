<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laguna Fire Station Locator</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/dark/main.css">
  <style>
    html,body,#viewDiv{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:#121212}
    .app{display:grid;grid-template-columns:360px 1fr;height:100vh}
    .sidebar{padding:16px;background:#1e1e1e;color:#fff;overflow:auto;box-shadow:2px 0 10px rgba(0,0,0,0.3)}
    .sidebar h3{color:#ff5252;margin-top:0;font-size:1.4rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .controls button,input,select{padding:10px;border-radius:8px;border:1px solid #333;background:#2c2c2c;color:#fff;font-size:0.9rem;cursor:pointer}
    .controls button:hover,.controls select:hover{background:#444}
    .list{margin-top:12px}
    .card{background:#2a2a2a;padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
    .card h4{margin:0 0 6px 0;color:#ff5252;font-size:1rem}
    .card small{color:#bbb}
    .card p{margin:6px 0;color:#ddd;font-size:0.85rem}
    .btn-center,.btn-dir{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.85rem}
    .btn-center{background:#ff5252;color:#fff}
    .btn-dir{background:#2979ff;color:#fff}
    .btn-center:hover{background:#e64545}
    .btn-dir:hover{background:#1f5fd1}
    #viewDiv{height:100%;border:none !important;background:transparent !important}
    .esri-view-surface{background:#f0f0f0 !important}
    hr{border:none;height:1px;background:#333;margin:16px 0}
    small{color:#aaa}
    .esri-popup__main-container{background:#1e1e1e !important;color:#fff !important;border-radius:10px !important;box-shadow:0 2px 10px rgba(0,0,0,0.4)}
    .esri-popup__header-title{color:#ff5252 !important;font-weight:bold}
    .legend img{vertical-align:middle;margin-right:6px}
    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar {
        grid-row: 1;
        grid-column: 1;
        height: auto;
        max-height: 50vh;
        overflow-y: auto;
      }
      #viewDiv {
        grid-row: 2;
        grid-column: 1;
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h3>üöí Laguna Fire Stations & Hydrants Locator</h3>

      <div class="legend" style="margin:8px 0 12px;font-size:0.9rem;color:#ccc">
        <strong>Legend</strong><br>
        <img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png" width="16"> Fire Station <br>
        <img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="16"> Hydrant <br>
        <span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:green;border:1px solid #fff;margin-right:6px"></span> Your Location
      </div>

      <div class="controls">
        <button id="locateBtn">üìç Use My Location</button>
        <button id="nearestBtn">‚≠ê Find Nearest</button>

        <label style="display:flex;align-items:center;gap:6px;color:#ddd;font-size:0.85rem">
          Radius (km)
          <input id="radius" type="range" min="1" max="50" value="10" style="margin-left:8px"/>
        </label>

        <select id="filterType" title="Filter type">
          <option value="all">All</option>
          <option value="station">Fire Stations</option>
          <option value="hydrant">Hydrants</option>
        </select>
      </div>

      <div>
        <input id="search" placeholder="üîç Search by name or address" 
          style="width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#2c2c2c;color:#fff" />
      </div>

      <div class="list" id="list"></div>

      <hr />
      <small>üí° Tip: Click a marker or list item to center and view details. "Directions" opens Google Maps.</small>
    </aside>

    <div id="viewDiv"></div>
  </div>

  <script src="https://js.arcgis.com/4.24/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/widgets/Locate",
      "esri/widgets/Zoom",
      "esri/widgets/Home"
    ], function(Map, MapView, Graphic, Point, Locate, Zoom, Home) {

      const features = [
        { id: 1, type: 'station', name: 'Cabuyao Fire Station', contact: '(049) 544 5628', hours: '24/7', address: '74CF+GVJ, Barangay Sala, Cabuyao, Laguna, Cabuyao City', coords: [121.1245817427208, 14.271384727731627], mapsUrl: "https://www.google.com/maps/place/Cabuyao+Fire+Station/@14.2711884,121.124688,19.5z/data=!4m6!3m5!1s0x3397d86263f462db:0x9ae1e1ed7912ff7e!8m2!3d14.2713354!4d121.1246303!16s%2Fg%2F1hc5pmbqk" },
        { id: 2, type: 'station', name: 'Santa Rosa City Fire Station', contact: '(049) 534 1291', hours: '24/7', address: '8486+863, Rizal Ave, City of Santa Rosa, 4026 Laguna', coords: [121.11057201775614, 14.31585359503307] },
        { id: 3, type: 'station', name: 'Bureau of Fire Protection Regional Office 4a CALABARZON', contact: '(049) 545 1695', hours: '24/7', address: '4A Camp Vicente Lim Rd, Calamba, 4027 Laguna', coords: [121.11799079476646, 14.215618801662085], mapsUrl: "https://www.google.com/maps/place/Bureau+of+Fire+Protection+Regional+Office+4a+CALABARZON/@14.2148434,121.1196038,18z/data=!4m6!3m5!1s0x33bd6303b7f49175:0xd4d65be3dde426c8!8m2!3d14.2156084!4d121.1179622!16s%2Fg%2F1thxsrqm" },
        { id: 4, type: 'station', name: 'Calamba City Fire Station', contact: '(049) 545 1695', hours: '24/7', address: '55V5+9P6, Bacnotan Rd, Calamba, 4027 Laguna', coords: [121.1592981904114, 14.193493079197673] },
        { id: 5, type: 'station', name: 'Batong Malake Fire Station', contact: '(049) 536 4349', hours: '24/7', address: '56CR+HQJ, Opal St, Los Ba√±os, Laguna', coords: [121.24196906614863, 14.171576573560756] },
        { id: 6, type: 'station', name: 'Bureau of Fire Protection San Pablo', contact: '(046) 801 8955', hours: '24/7', address: '38CG+5C2, Inocencio Barleta St, San Pablo City, Laguna', coords: [121.32609129672522, 14.070358099856383] },
        { id: 7, type: 'station', name: 'Bay Fire Station - BFP Bay, Laguna', contact: '09662869744', hours: '24/7', address: '57JM+3RX, J. Tanalega St, Bay, Laguna', coords: [121.28461064158401, 14.180277624169516] },
        { id: 8, type: 'station', name: 'BFP Victoria Fire Station', contact: '(049)523 3368', hours: '24/7', address: '68HH+3CH, E Quirino St, Victoria, Laguna', coords: [121.32858058036233, 14.227770881030736] },
        { id: 9, type: 'station', name: 'Pila Fire Station', contact: '5590511', hours: '24/7', address: 'Ruiz St., Brgy Bulilan Norte Brgy, Pila, 4010 Laguna', coords: [121.3669691275018, 14.233777271804547] },
        { id:10, type: 'station', name: 'Pagsanjan Fire Station', contact: '09321467933', hours: '24/7', address: '7FM4+3X9, Pagsanjan, Laguna', coords: [121.45747211667471, 14.28276434645187] },
        { id:11, type: 'station', name: 'Lumban Fire Station', contact: '(049) 557 0771', hours: '24/7', address: '7FX7+M36, National Hwy, Lumban, 4014 Laguna', coords: [121.46263883305267, 14.299204219918012] },
        { id:12, type: 'station', name: 'Magdalena Fire Station', contact: '(049) 503 3446', hours: '24/7', address: '6C2H+4MP, Zamora, Magdalena, Laguna', coords: [121.42920138780032, 14.200391792207448] },
        { id:13, type: 'station', name: 'Liliw Fire Station', contact: '(046) 563 2868', hours: '24/7', address: '4CMM+GFH, Liliw, Laguna', coords: [121.43371319330328, 14.133834987478497] },
        { id:14, type: 'station', name: 'Majayjay Fire Station', contact: '09663496148', hours: '24/7', address: 'P Zamora St. Brgy, Majayjay, Laguna', coords: [121.4720818424173, 14.140968745676155] },
        { id:15, type: 'station', name: 'Luisiana Municipal Fire Station', contact: '(046) 555 3300', hours: '24/7', address: '5GM6+F7Q, Ibanez St, Luisiana, 4032 Laguna', coords: [121.51073562494729, 14.18373599291222] },
        { id:16, type: 'station', name: 'Cavinti Fire Station', contact: '09162346589', hours: '24/7', address: '7F3W+5JV, National Road, Cavinti, Laguna', coords: [121.49655599969712, 14.253048721495212] },
        { id:17, type: 'station', name: 'Nagcarlan Fire Station', contact: '(049) 530 7357', hours: '24/7', address: '4CM8+534, Nagcarlan Municipal Compound, Rizal Avenue, Brgy, Nagcarlan, Laguna', coords: [121.41516259168674, 14.132931609380623] },
        { id:18, type: 'station', name: 'Alaminos Fire Station', contact: '(049) 521 0153', hours: '24/7', address: '368W+6M5, D Fandino, Barangay 2, Alaminos, Laguna', coords: [121.24685832694098, 14.065362760678617] },
        { id:19, type: 'hydrant', name: 'Hydrant - Sta Rosa Market', contact: 'N/A', hours: 'N/A', address: 'Sta. Rosa Public Market', coords: [121.1115, 14.3129] },
        { id:20, type: 'hydrant', name: 'Hydrant - Calamba Crossing', contact: 'N/A', hours: 'N/A', address: 'Calamba Crossing', coords: [121.1645, 14.2110] },
        { id:21, type: 'hydrant', name: 'Hydrant - Bi√±an Plaza', contact: 'N/A', hours: 'N/A', address: 'Bi√±an Town Plaza', coords: [121.0820, 14.3400] }
      ];

      const map = new Map({ basemap: 'streets-vector' });
      const view = new MapView({ container: 'viewDiv', map: map, center: [121.1653, 14.2116], zoom: 10 });

      view.ui.add(new Locate({ view }), 'top-left');
      view.ui.add(new Zoom({ view }), 'bottom-left');
      view.ui.add(new Home({ view }), 'top-left');

      let userLocation = null;

      const stationSymbol = { type: 'picture-marker', url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', width: '26px', height: '26px' };
      const hydrantSymbol = { type: 'picture-marker', url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', width: '20px', height: '20px' };
      const userSymbol = { type: 'simple-marker', style: 'circle', size: '12px', outline: { color: 'white', width: 1 }, color: [0,200,0,0.95] };

      function makeTemplate(f) {
        return {
          title: f.name,
          content: `
            <div>
              <p><strong>Address:</strong> ${f.address || 'N/A'}</p>
              <p><strong>Contact:</strong> ${f.contact || 'N/A'}</p>
              <p><strong>Hours:</strong> ${f.hours || 'N/A'}</p>
              <p><a target='_blank' href='${directionLink(f)}'>üöó Get Directions</a></p>
            </div>`
        };
      }

      function drawGraphics() {
        view.graphics.removeAll();
        const filter = document.getElementById('filterType').value;
        let items = features.filter(f => filter === 'all' || f.type === filter);

        if (userLocation) {
          const radiusKm = Number(radiusEl.value);
          items = items
            .map(it => ({ ...it, distanceKm: haversine(userLocation.lat, userLocation.lng, it.coords[1], it.coords[0]) }))
            .filter(it => it.distanceKm <= radiusKm)
            .sort((a, b) => a.distanceKm - b.distanceKm);

          if (items.length === 1) {
            items = [items[0]];
          }
        }

        items.forEach(f => {
          const symbol = f.type === 'station' ? stationSymbol : hydrantSymbol;
          const g = new Graphic({
            geometry: new Point({ longitude: f.coords[0], latitude: f.coords[1] }),
            symbol,
            attributes: f,
            popupTemplate: makeTemplate(f)
          });
          view.graphics.add(g);
        });

        if (userLocation) {
          const ug = new Graphic({
            geometry: new Point({ longitude: userLocation.lng, latitude: userLocation.lat }),
            symbol: userSymbol
          });
          ug.attributes = { __is_user: true };
          view.graphics.add(ug);
        }
      }

      const listEl = document.getElementById('list');
      const searchEl = document.getElementById('search');
      const radiusEl = document.getElementById('radius');

      function renderList() {
        listEl.innerHTML = '';
        const q = searchEl.value.trim().toLowerCase();
        const radiusKm = Number(radiusEl.value);
        const filter = document.getElementById('filterType').value;

        let items = features.filter(f => (filter === 'all' || f.type === filter) &&
          (q === '' || (f.name + ' ' + (f.address || '')).toLowerCase().includes(q)));

        if (userLocation) {
          items = items
            .map(it => ({ ...it, distanceKm: haversine(userLocation.lat, userLocation.lng, it.coords[1], it.coords[0]) }))
            .filter(it => it.distanceKm <= radiusKm)
            .sort((a,b) => a.distanceKm - b.distanceKm);

          if (items.length === 1) {
            items = [items[0]];
          }
        }

        if (items.length === 0) {
          listEl.innerHTML = '<p><em>No results.</em></p>';
          return;
        }

        items.forEach(it => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h4>${it.name}</h4>
            <small>${it.address}${it.distanceKm?` ‚Äî ${it.distanceKm.toFixed(2)} km`:''}</small>
            <p><strong>Contact:</strong> ${it.contact || 'N/A'}</p>
            <p><strong>Hours:</strong> ${it.hours || 'N/A'}</p>
          `;
          const btns = document.createElement('div');
          btns.style.display = 'flex'; btns.style.gap = '8px'; btns.style.marginTop = '8px';

          const cBtn = document.createElement('button');
          cBtn.className = 'btn-center';
          cBtn.textContent = 'Center';
          cBtn.onclick = () => centerOn(it);

          const dBtn = document.createElement('button');
          dBtn.className = 'btn-dir';
          dBtn.textContent = 'Directions';
          dBtn.onclick = () => window.open(directionLink(it), '_blank');

          btns.appendChild(cBtn);
          btns.appendChild(dBtn);
          card.appendChild(btns);
          listEl.appendChild(card);
        });
      }

      function centerOn(item) {
        view.goTo({ center: item.coords, zoom: 13 }).then(() => {
          const g = view.graphics.items.find(gr => gr.attributes && gr.attributes.id === item.id);
          if (g) view.popup.open({ location: g.geometry, features: [g] });
        });
      }

      function directionLink(item) {
        if (item.mapsUrl) {
          return item.mapsUrl;
        }
        const dest = `${item.coords[1]},${item.coords[0]}`;
        if (userLocation) {
          const origin = `${userLocation.lat},${userLocation.lng}`;
          return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving`;
        }
        return `https://www.google.com/maps/search/?api=1&query=${dest}`;
      }

      function haversine(lat1, lon1, lat2, lon2) {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      searchEl.addEventListener('input', renderList);
      radiusEl.addEventListener('input', () => { renderList(); drawGraphics(); });
      document.getElementById('filterType').addEventListener('change', () => { drawGraphics(); renderList(); });

      document.getElementById('locateBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            view.graphics.items.filter(g => g.attributes && g.attributes.__is_user).forEach(g => view.graphics.remove(g));
            const ug = new Graphic({ geometry: new Point({ longitude: userLocation.lng, latitude: userLocation.lat }), symbol: userSymbol });
            ug.attributes = { __is_user: true };
            view.graphics.add(ug);
            view.goTo({ center: [userLocation.lng, userLocation.lat], zoom: 12 });
            renderList();
            drawGraphics();
          }, err => alert('Unable to get location: ' + err.message));
        } else {
          alert('Geolocation not supported by your browser.');
        }
      });

      document.getElementById('nearestBtn').addEventListener('click', () => {
        if (!userLocation) { alert('Click "Use My Location" first.'); return; }
        const stations = features.filter(f => f.type === 'station')
          .map(s => ({ ...s, distanceKm: haversine(userLocation.lat, userLocation.lng, s.coords[1], s.coords[0]) }));
        if (stations.length === 0) { alert('No stations available.'); return; }
        stations.sort((a,b) => a.distanceKm - b.distanceKm);
        const nearest = stations[0];
        centerOn(nearest);
        view.popup.open({ title: nearest.name, location: new Point({ longitude: nearest.coords[0], latitude: nearest.coords[1] }), content: `Nearest station: ${nearest.name} ‚Äî ${nearest.distanceKm.toFixed(2)} km` });
      });

      // ‚úÖ Hover popup without moving map
      let lastHovered = null;
      view.on("pointer-move", (event) => {
        view.hitTest(event).then((response) => {
          const result = response.results.find(r => r.graphic && r.graphic.attributes && r.graphic.attributes.name);
          if (result && result.graphic !== lastHovered) {
            lastHovered = result.graphic;
            view.popup.open({
              location: result.graphic.geometry,
              features: [result.graphic],
              updateLocationEnabled: false
            });
          } else if (!result) {
            view.popup.close();
            lastHovered = null;
          }
        });
      });


      view.when(() => { drawGraphics(); renderList(); });

    });
  </script>
</body>
</html>
